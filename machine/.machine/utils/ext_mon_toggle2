#!/usr/bin/env sh

WALLPAPER_DIR="$HOME/.machine/images/backgrounds"
DEFAULT_WALLPAPER="bg2.jpg"
SEXY_WALLPAPER="bg.png"

# Function to set the wallpaper
set_wallpaper() {
    local img="$1"
    echo "Setting wallpaper: $WALLPAPER_DIR/$img"

    # Kill any existing Nitrogen instances
    pkill nitrogen

    # Restore Nitrogen settings
    nohup nitrogen --restore >/dev/null 2>&1 &

    # Apply the selected wallpaper
    nohup nitrogen --set-zoom-fill "$WALLPAPER_DIR/$img" --head=0 >/dev/null 2>&1 &
    sleep 1
    nohup nitrogen --set-zoom-fill "$WALLPAPER_DIR/$img" --head=1 >/dev/null 2>&1 &
}

# Function to configure monitors
configure_monitors() {
    local scale="$1"

    # Detect external monitor (exclude eDP-1)
    EXTERNAL_MONITOR=$(xrandr | awk '/ connected/ && $1 != "eDP-1" { print $1; exit }')

    if [ -n "$EXTERNAL_MONITOR" ]; then
        echo "External monitor detected: $EXTERNAL_MONITOR"

        RESOLUTION=$(xrandr | grep -A1 "^$EXTERNAL_MONITOR connected" | awk 'NR==2 { print $1 }')
        echo "Using resolution $RESOLUTION for $EXTERNAL_MONITOR."

        # Configure extended layout
        xrandr \
          --output eDP-1 --primary --mode 1920x1200 --pos 0x0 --scale 1.5x1.5 \
          --output "$EXTERNAL_MONITOR" --mode "$RESOLUTION" --pos 2880x0 --scale "${scale}x${scale}"

        set_wallpaper "$IMG_NAME"
    else
        echo "No external monitor detected. Disabling others..."
        xrandr \
          --output eDP-1 --primary --mode 1920x1200 --pos 0x0 --scale 1.5x1.5 \
          --output HDMI-1 --off \
          --output DP-3-1 --off \
          --output DP-3-2 --off \
          --output DP-3-3 --off
        set_wallpaper "$IMG_NAME"
    fi
}

# Parse arguments
SCALE_EXTERNAL=1.75
IMG_NAME="$DEFAULT_WALLPAPER"

for arg in "$@"; do
    case "$arg" in
        --big)
            SCALE_EXTERNAL=1.0
            echo "Using larger scale for external monitor."
            ;;
        --sexy)
            IMG_NAME="$SEXY_WALLPAPER"
            echo "ðŸ”¥ Applying sexy wallpaper: $IMG_NAME ðŸ”¥"
            ;;
        *)
            if [ -f "$WALLPAPER_DIR/$arg" ]; then
                IMG_NAME="$arg"
                echo "Using custom wallpaper: $IMG_NAME"
            fi
            ;;
    esac
done

configure_monitors "$SCALE_EXTERNAL"
